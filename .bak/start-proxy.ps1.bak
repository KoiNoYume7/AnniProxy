# Requires: PowerShell 7+

# ===================== #
# Yumehana Secure Proxy #
# ===================== #

param(
    [switch]$NoLogo,
    [ValidateSet("INFO","OK","WARN","ERROR","ALL")]
    [string]$LogLevel,
    [switch]$NoTimestamp
)

# --- Development Defaults --- #
$DEV_NoLogo = $false
$DEV_LogLevel = "ALL"
$DEV_NoTimestamp = $false

# --- Effective Configuration --- #
$NoLogo      = if ($PSBoundParameters.ContainsKey("NoLogo"))      { $NoLogo }      else { $DEV_NoLogo }
$LogLevel    = if ($PSBoundParameters.ContainsKey("LogLevel"))    { $LogLevel }    else { $DEV_LogLevel }
$NoTimestamp = if ($PSBoundParameters.ContainsKey("NoTimestamp")) { $NoTimestamp } else { $DEV_NoTimestamp }

# ---- Paths (relative to USB root) ---- #
$BaseDir = Split-Path -Parent $PSScriptRoot

$Cloudflared = Join-Path $BaseDir ".portable\cloudflared\cloudflared.exe"
$Brave       = Join-Path $BaseDir "PApps_\brave-portable\brave-portable.exe"
$LogDir      = Join-Path $BaseDir ".logs"
$LogoScript  = Join-Path $PSScriptRoot "LogoASCII.ps1"
$LockFile    = Join-Path $BaseDir ".session.lock"

# ---- SSH / Proxy config ---- #
$SocksPort = 1080
$SshUser   = "akira"
$SshHost   = "yme-04.yumehana.dev"

# ---- Log file ---- #
if (-not (Test-Path $LogDir)) {
    New-Item -ItemType Directory -Path $LogDir | Out-Null
}

$Timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
$LogFile   = Join-Path $LogDir "session-$Timestamp.log"

# ---- UI polish ---- #
$Host.UI.RawUI.WindowTitle = "Yumehana Secure Proxy"

if (-not $NoLogo -and (Test-Path $LogoScript)) {
    try {
        . $LogoScript
        Show-AnniArt
    } catch {
        # Logo failure should never break functionality
    }
}

# --- Logging Function --- #
function Log {
    param(
        [string]$Message,
        [ValidateSet("INFO","OK","WARN","ERROR")]
        [string]$Level = "INFO"
    )

    if ($LogLevel -ne "ALL" -and $LogLevel -ne $Level) {
        return
    }

    $timePart = if ($NoTimestamp) { "" } else { "[{0}]" -f (Get-Date -Format "HH:mm:ss") }
    $line = "$timePart[$Level] $Message"

    switch ($Level) {
        "INFO"  { Write-Host $line -ForegroundColor Cyan }
        "OK"    { Write-Host $line -ForegroundColor Green }
        "WARN"  { Write-Host $line -ForegroundColor Yellow }
        "ERROR" { Write-Host $line -ForegroundColor Red }
    }

    Add-Content -Path $LogFile -Value $line
}

# --- Dev Message --- #
function Message {
    param([string]$Text)

    Write-Host ""
    Write-Host ">>> $Text" -ForegroundColor Blue
    Write-Host ""
}

# --- Single Session Guard --- #
if (Test-Path $LockFile) {
    Message "Another session is already running. Please close it first."
    exit 1
}

New-Item -ItemType File -Path $LockFile -Force | Out-Null

# --- Main Runtime (TRY) --- #
try {

    $HadErrors = $false
    Log "Starting secure proxy session"

    if (-not (Test-Path $Cloudflared)) {
        Log "cloudflared.exe not found" "ERROR"
        $HadErrors = $true
    }

    if (-not (Test-Path $Brave)) {
        Log "Brave Portable not found" "ERROR"
        $HadErrors = $true
    }

    if ($HadErrors) {
        Message "Startup failed. It must've been my fault, except if you changed something or didn't follow the instructions."
        exit 1
    }

    # --- Start SSH SOCKS Tunnel --- #
    Log "Launching SSH SOCKS tunnel on port $SocksPort"
    Log "Waiting for SSH authentication"

    $SshArgs = @(
        "-N",
        "-D", "127.0.0.1:$SocksPort",
        "-o", "ProxyCommand=`"$Cloudflared access ssh --hostname %h`"",
        "$SshUser@$SshHost"
    )

    $SshProcess = Start-Process `
        -FilePath "ssh.exe" `
        -ArgumentList $SshArgs `
        -NoNewWindow `
        -PassThru

    function Test-Socks {
        try {
            $client = New-Object System.Net.Sockets.TcpClient
            $client.Connect("127.0.0.1", $SocksPort)
            $client.Close()
            return $true
        } catch {
            return $false
        }
    }

    Log "Waiting for proxy to become available... (timeout: 20s)"
    Message "Please provide SSH authentication if prompted"

    $Ready = $false
    for ($i = 1; $i -le 20; $i++) {
        if (Test-Socks) {
            $Ready = $true
            break
        }
        Start-Sleep -Seconds 1
    }

    if (-not $Ready) {
        Log "SOCKS proxy did not become available" "ERROR"
        Message "Wrong password or you took too long0."
        exit 1
    }

    Log "SOCKS proxy is live on localhost:$SocksPort" "OK"

    # --- Launch Brave --- #
    Log "Launching Brave Portable"

    $BraveProcess = Start-Process `
        -FilePath $Brave `
        -ArgumentList "--proxy-server=socks5://127.0.0.1:$SocksPort" `
        -PassThru

    Message "Everything is setup and seems to be working, enjoy!"

    # --- Monitor Processes --- #
    while ($true) {
        if ($SshProcess.HasExited) {
            Log "SSH tunnel closed, shutting down browser" "WARN"
            try { $BraveProcess.Kill() } catch {}
            break
        }

        if ($BraveProcess.HasExited) {
            Log "Browser closed by user, shutting down tunnel" "WARN"
            try { $SshProcess.Kill() } catch {}
            break
        }

        Start-Sleep -Seconds 1
    }

}
finally {
    if (Test-Path $LockFile) {
        Remove-Item $LockFile -Force
    }
}

# --- end of start-proxy.ps1 --- #